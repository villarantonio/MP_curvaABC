name: Processamento de Vendas - An√°lise ABC e Temporal

on:
  push:
    paths:
      - 'dados_vendas.csv'
  workflow_dispatch:
    inputs:
      arquivo_dados:
        description: 'Nome do arquivo de dados a processar (CSV ou XLSX)'
        required: false
        default: 'dados_vendas.csv'

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  ARQUIVO_DADOS: ${{ github.event.inputs.arquivo_dados || 'dados_vendas.csv' }}

jobs:
  analise-vendas:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 horas devido aos delays de rate limit

    permissions:
      contents: write

    steps:
      # 1. Checkout do reposit√≥rio
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. Configurar Python
      - name: üêç Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. Instalar depend√™ncias
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Verificar se arquivo de dados existe
      - name: üîç Verificar arquivo de dados
        run: |
          echo "üìÇ Listando arquivos de dados no diret√≥rio:"
          ls -la *.xlsx *.csv 2>/dev/null || echo "Nenhum arquivo de dados encontrado"
          ARQUIVO="${{ env.ARQUIVO_DADOS }}"
          if [ ! -f "$ARQUIVO" ]; then
            echo "‚ùå Arquivo '$ARQUIVO' n√£o encontrado!"
            exit 1
          fi
          echo "‚úÖ Arquivo '$ARQUIVO' encontrado"
          echo "üìä Tamanho: $(ls -lh "$ARQUIVO" | awk '{print $5}')"

      # 5. Executar an√°lise ABC (Curva ABC)
      - name: üìà Executar An√°lise ABC (relatorio_teste.py)
        continue-on-error: true
        run: |
          echo "üöÄ Iniciando an√°lise ABC..."
          ARQUIVO="${{ env.ARQUIVO_DADOS }}"
          python relatorio_teste.py "$ARQUIVO"
          echo "‚úÖ An√°lise ABC conclu√≠da"

      # 6. Executar an√°lise temporal (todas as lojas)
      - name: üìÖ Executar An√°lise Temporal (analise_temporal.py)
        continue-on-error: true
        run: |
          echo "üöÄ Iniciando an√°lise temporal..."
          ARQUIVO="${{ env.ARQUIVO_DADOS }}"
          python analise_temporal.py "$ARQUIVO"
          echo "‚úÖ An√°lise temporal conclu√≠da"

      # 7. Verificar JSONs gerados
      - name: üîç Verificar arquivos JSON gerados
        run: |
          echo "üìÅ Arquivos JSON encontrados:"
          ls -la *.json 2>/dev/null || echo "‚ö†Ô∏è Nenhum arquivo JSON encontrado"
          echo ""
          echo "üìä Resumo dos arquivos gerados:"
          for f in *.json; do
            if [ -f "$f" ]; then
              echo "  - $f ($(wc -c < "$f") bytes)"
            fi
          done

      # 8. Configurar Git para commit
      - name: üîß Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      # 9. Commit e push dos resultados
      - name: üì§ Commit dos resultados JSON
        run: |
          # Adiciona todos os JSONs gerados
          git add *.json 2>/dev/null || true
          
          # Verifica se h√° mudan√ßas para commitar
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Nenhuma altera√ß√£o nos arquivos JSON para commitar"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "chore: atualiza√ß√£o autom√°tica dos resultados de an√°lise [skip ci]

            üìÖ Data: $TIMESTAMP
            üìä Arquivo processado: ${{ env.ARQUIVO_DADOS }}
            ü§ñ Gerado automaticamente pelo GitHub Actions"
            
            git push
            echo "‚úÖ Resultados commitados com sucesso!"
          fi

      # 10. Sum√°rio da execu√ß√£o
      - name: üìã Sum√°rio da Execu√ß√£o
        if: always()
        run: |
          echo "## üìä Resumo da Execu√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Arquivo processado | \`${{ env.ARQUIVO_DADOS }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Data/Hora | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Arquivos JSON gerados:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la *.json 2>/dev/null || echo "Nenhum JSON encontrado"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

