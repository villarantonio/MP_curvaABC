name: Processamento de Vendas - AnÃ¡lise ABC e Temporal

on:
  push:
    paths:
      - 'dados_entrada.csv'
  workflow_dispatch:
    inputs:
      arquivo_csv:
        description: 'Nome do arquivo CSV a processar'
        required: false
        default: 'dados_entrada.csv'

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  ARQUIVO_CSV: ${{ github.event.inputs.arquivo_csv || 'dados_entrada.csv' }}

jobs:
  analise-vendas:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 horas devido aos delays de rate limit

    permissions:
      contents: write

    steps:
      # 1. Checkout do repositÃ³rio
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. Configurar Python
      - name: ğŸ Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 3. Instalar dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Verificar se arquivo CSV existe
      - name: ğŸ” Verificar arquivo CSV
        run: |
          if [ ! -f "${{ env.ARQUIVO_CSV }}" ]; then
            echo "âŒ Arquivo ${{ env.ARQUIVO_CSV }} nÃ£o encontrado!"
            exit 1
          fi
          echo "âœ… Arquivo ${{ env.ARQUIVO_CSV }} encontrado"
          echo "ğŸ“Š Linhas no arquivo: $(wc -l < ${{ env.ARQUIVO_CSV }})"

      # 5. Executar anÃ¡lise ABC (Curva ABC)
      - name: ğŸ“ˆ Executar AnÃ¡lise ABC (relatorio_teste.py)
        continue-on-error: true
        run: |
          echo "ğŸš€ Iniciando anÃ¡lise ABC..."
          python relatorio_teste.py "${{ env.ARQUIVO_CSV }}"
          echo "âœ… AnÃ¡lise ABC concluÃ­da"

      # 6. Executar anÃ¡lise temporal (todas as lojas)
      - name: ğŸ“… Executar AnÃ¡lise Temporal (analise_temporal.py)
        continue-on-error: true
        run: |
          echo "ğŸš€ Iniciando anÃ¡lise temporal..."
          python analise_temporal.py "${{ env.ARQUIVO_CSV }}"
          echo "âœ… AnÃ¡lise temporal concluÃ­da"

      # 7. Verificar JSONs gerados
      - name: ğŸ” Verificar arquivos JSON gerados
        run: |
          echo "ğŸ“ Arquivos JSON encontrados:"
          ls -la *.json 2>/dev/null || echo "âš ï¸ Nenhum arquivo JSON encontrado"
          echo ""
          echo "ğŸ“Š Resumo dos arquivos gerados:"
          for f in *.json; do
            if [ -f "$f" ]; then
              echo "  - $f ($(wc -c < "$f") bytes)"
            fi
          done

      # 8. Configurar Git para commit
      - name: ğŸ”§ Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      # 9. Commit e push dos resultados
      - name: ğŸ“¤ Commit dos resultados JSON
        run: |
          # Adiciona todos os JSONs gerados
          git add *.json 2>/dev/null || true
          
          # Verifica se hÃ¡ mudanÃ§as para commitar
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma alteraÃ§Ã£o nos arquivos JSON para commitar"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "chore: atualizaÃ§Ã£o automÃ¡tica dos resultados de anÃ¡lise [skip ci]

            ğŸ“… Data: $TIMESTAMP
            ğŸ“Š Arquivo processado: ${{ env.ARQUIVO_CSV }}
            ğŸ¤– Gerado automaticamente pelo GitHub Actions"
            
            git push
            echo "âœ… Resultados commitados com sucesso!"
          fi

      # 10. SumÃ¡rio da execuÃ§Ã£o
      - name: ğŸ“‹ SumÃ¡rio da ExecuÃ§Ã£o
        if: always()
        run: |
          echo "## ğŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Arquivo processado | \`${{ env.ARQUIVO_CSV }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Data/Hora | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Arquivos JSON gerados:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la *.json 2>/dev/null || echo "Nenhum JSON encontrado"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

