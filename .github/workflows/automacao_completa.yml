name: Automa√ß√£o Completa - Download SharePoint + An√°lise + Dashboard

# =====================================================
# WORKFLOW SUBSTITUI O N8N - EXECUTA TUDO NO GITHUB
# =====================================================
# Este workflow:
# 1. Baixa o arquivo Excel do SharePoint (sem limite de mem√≥ria do n8n)
# 2. Executa as an√°lises com Gemini AI
# 3. Faz commit autom√°tico dos JSONs para o dashboard

on:
  # Agendamento autom√°tico (substitui o trigger do n8n)
  schedule:
    - cron: '0 9 * * *'  # Executa todo dia √†s 9h UTC (6h Bras√≠lia)
  
  # Permite execu√ß√£o manual
  workflow_dispatch:
    inputs:
      sharepoint_url:
        description: 'URL do SharePoint (deixe vazio para usar a URL padr√£o)'
        required: false
        default: ''
      forcar_download:
        description: 'For√ßar novo download mesmo se arquivo existir'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # URL padr√£o do SharePoint (pode ser sobrescrita pelo input)
  SHAREPOINT_URL_PADRAO: 'https://mandapicanha-my.sharepoint.com/:x:/r/personal/mandapicanha_mandapicanha_onmicrosoft_com/_layouts/15/Doc.aspx?sourcedoc=%7B8C63D151-AE36-4C67-94FA-4B07FFDD547E%7D&file=GMRMPMA%20(2).xlsx&action=default&mobileredirect=true&share=cQpR0WOMNq5nTJT6Swf_3VR-EgUALlrUXl8xMvWRhVuZm4LLfg'
  ARQUIVO_DADOS: 'dados_vendas.xlsx'
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  # Credenciais Azure (opcionais - para links privados)
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

jobs:
  download-e-analise:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 horas (arquivos grandes podem demorar)

    permissions:
      contents: write

    steps:
      # =====================================================
      # FASE 1: PREPARA√á√ÉO
      # =====================================================
      
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üêç Configurar Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install requests  # Para download do SharePoint

      # =====================================================
      # FASE 2: DOWNLOAD DO SHAREPOINT
      # =====================================================

      - name: üîó Determinar URL do SharePoint
        id: url
        run: |
          INPUT_URL="${{ github.event.inputs.sharepoint_url }}"
          if [ -n "$INPUT_URL" ]; then
            echo "url=$INPUT_URL" >> $GITHUB_OUTPUT
            echo "üìå Usando URL fornecida manualmente"
          else
            echo "url=${{ env.SHAREPOINT_URL_PADRAO }}" >> $GITHUB_OUTPUT
            echo "üìå Usando URL padr√£o configurada"
          fi

      - name: üì• Download do arquivo do SharePoint
        env:
          SHAREPOINT_URL: ${{ steps.url.outputs.url }}
        run: |
          echo "üîó Iniciando download do SharePoint..."
          echo "üìÅ Arquivo de destino: ${{ env.ARQUIVO_DADOS }}"
          
          # Executa script de download
          python scripts/download_sharepoint.py "$SHAREPOINT_URL" "${{ env.ARQUIVO_DADOS }}"
          
          # Verifica se arquivo foi baixado
          if [ -f "${{ env.ARQUIVO_DADOS }}" ]; then
            echo "‚úÖ Download conclu√≠do com sucesso!"
            echo "üìä Tamanho: $(ls -lh "${{ env.ARQUIVO_DADOS }}" | awk '{print $5}')"
            echo "üìã Linhas estimadas: $(python -c "import pandas as pd; print(len(pd.read_excel('${{ env.ARQUIVO_DADOS }}', nrows=None)))" 2>/dev/null || echo "N/A")"
          else
            echo "‚ùå Falha no download!"
            exit 1
          fi

      # =====================================================
      # FASE 3: AN√ÅLISES COM IA
      # =====================================================

      - name: üìà Executar An√°lise ABC (Curva ABC)
        continue-on-error: true
        run: |
          echo "üöÄ Iniciando an√°lise ABC..."
          python scripts/relatorio_teste.py "${{ env.ARQUIVO_DADOS }}"
          echo "‚úÖ An√°lise ABC conclu√≠da"

      - name: üìÖ Executar An√°lise Temporal Multi-Granularidade
        continue-on-error: true
        run: |
          echo "üöÄ Iniciando an√°lise temporal (di√°rio, semanal, mensal)..."
          python scripts/analise_temporal_multi.py "${{ env.ARQUIVO_DADOS }}" --all
          echo "‚úÖ An√°lise temporal multi-granularidade conclu√≠da"

      # =====================================================
      # FASE 4: VERIFICA√á√ÉO E COMMIT DOS JSONS
      # =====================================================

      - name: üîç Verificar arquivos JSON gerados
        run: |
          echo "üìÅ Arquivos JSON na raiz:"
          ls -la *.json 2>/dev/null || echo "‚ö†Ô∏è Nenhum arquivo JSON na raiz"
          echo ""
          echo "üìÅ Arquivos JSON em docs/data/:"
          ls -la docs/data/*.json 2>/dev/null || echo "‚ö†Ô∏è Nenhum arquivo JSON em docs/data/"
          echo ""
          echo "üìä Resumo dos arquivos gerados:"
          for f in docs/data/*.json; do
            if [ -f "$f" ]; then
              SIZE=$(wc -c < "$f")
              echo "  ‚úÖ $f ($SIZE bytes)"
            fi
          done

      - name: üîß Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

      - name: üì§ Commit dos resultados JSON para o Dashboard
        run: |
          # Adiciona apenas os JSONs (n√£o o arquivo de dados grande)
          git add *.json 2>/dev/null || true
          git add docs/data/*.json 2>/dev/null || true
          
          # Verifica se h√° mudan√ßas
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Nenhuma altera√ß√£o nos arquivos JSON"
          else
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "chore: atualiza√ß√£o autom√°tica - dados do SharePoint [skip ci]
            
            üìÖ Data: $TIMESTAMP
            üìä Fonte: SharePoint (GMRMPMA)
            üìÅ JSONs atualizados em: docs/data/
            ü§ñ Workflow: Automa√ß√£o Completa (substitui n8n)"
            
            git push
            echo "‚úÖ JSONs commitados com sucesso!"
            echo "üåê Dashboard ser√° atualizado automaticamente"
          fi

      # =====================================================
      # FASE 5: SUM√ÅRIO DA EXECU√á√ÉO
      # =====================================================

      - name: üìã Sum√°rio da Execu√ß√£o
        if: always()
        run: |
          echo "## üöÄ Automa√ß√£o Completa - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Informa√ß√µes da Execu√ß√£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| üìÖ Data/Hora | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| üìÅ Arquivo baixado | \`${{ env.ARQUIVO_DADOS }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ -f "${{ env.ARQUIVO_DADOS }}" ]; then
            SIZE=$(ls -lh "${{ env.ARQUIVO_DADOS }}" | awk '{print $5}')
            echo "| üìä Tamanho | $SIZE |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÅ Arquivos JSON Gerados (Dashboard)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la docs/data/*.json 2>/dev/null || echo "Nenhum JSON em docs/data/"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links √öteis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Dashboard](https://yago-coqueiro.github.io/MP_curvaABC/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Arquivos de dados](./docs/data/)" >> $GITHUB_STEP_SUMMARY

